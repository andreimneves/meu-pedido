<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>DL Crepes e Lanches - Card√°pio Online</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header" id="header">
            <h1 id="nomeLoja">DL Crepes e Lanches</h1>
            <div class="slogan" id="slogan">Seu ref√∫gio de sabores no cora√ß√£o do Santa Marta</div>
            <div class="info">
                <span id="horario">üïí 18h √†s 23h</span>
                <span id="endereco">üìç Santa Marta</span>
            </div>
            
            <!-- Suporte WhatsApp -->
            <div class="suporte-whatsapp" id="suporteWhatsapp" onclick="abrirWhatsappSuporte()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
                <span>Tem alguma d√∫vida? Conte com a gente!</span>
            </div>
            
            <div class="cart-icon" onclick="abrirCarrinho()">
                üõí
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>

        <!-- BUSCA -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Buscar no card√°pio..." onkeyup="filtrarProdutos()">
        </div>

        <!-- CATEGORIAS -->
        <div class="categorias" id="categorias">
            <button class="categoria-btn ativa" onclick="filtrarCategoria('Todos')">Todos</button>
        </div>

        <!-- PRODUTOS -->
        <div class="produtos" id="produtos">
            <div class="loading">Carregando card√°pio...</div>
        </div>

        <!-- RODAP√â -->
        <footer>
            <p>¬© DL Crepes e Lanches - Todos os direitos reservados</p>
        </footer>
    </div>

    <!-- MODAL DO CARRINHO -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharCarrinho()">&times;</span>
            <h2>üõí Seu Carrinho</h2>
            
            <div class="cart-items" id="cartItems"></div>
            
            <div class="cart-total">
                <span>Total:</span> <strong>R$ <span id="cartTotal">0,00</span></strong>
            </div>

            <!-- √ÅREA DE AVISOS -->
            <div id="avisoDelivery" class="aviso-box" style="display: none;"></div>

            <!-- FORMUL√ÅRIO DE ENTREGA -->
            <div class="form-section">
                <h3>üìã Dados para entrega</h3>
                
                <div class="delivery-options">
                    <input type="radio" name="deliveryType" value="delivery" id="deliveryOption" onchange="toggleDelivery(true)">
                    <label for="deliveryOption" id="deliveryLabel">üöö Delivery</label>
                    
                    <input type="radio" name="deliveryType" value="pickup" id="pickupOption" onchange="toggleDelivery(false)" checked>
                    <label for="pickupOption" id="pickupLabel">üè† Retirada</label>
                </div>

                <div id="deliveryFields" style="display: none;">
                    <div class="form-row">
                        <label>üë§ Nome completo *</label>
                        <input type="text" id="clienteNome" placeholder="Digite seu nome">
                    </div>

                    <div class="form-row">
                        <label>üì± WhatsApp *</label>
                        <input type="tel" id="clienteTelefone" placeholder="(51) 99999-9999">
                    </div>

                    <div class="form-row">
                        <label>üìç CEP *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="cepInput" placeholder="00000-000" style="flex: 2;" oninput="mascaraCEP(this)" onblur="calcularFretePorCEP()">
                            <button type="button" onclick="calcularFretePorCEP()" style="flex: 1; background: #C83232; color: white; border: none; border-radius: 8px; cursor: pointer; padding: 12px;">Calcular</button>
                        </div>
                        <div class="cep-info" id="cepInfo"></div>
                    </div>

                    <div class="address-grid">
                        <div class="form-row" style="grid-column: 1/-1;">
                            <label>üè† Endere√ßo *</label>
                            <input type="text" id="clienteEndereco" placeholder="Rua, Avenida...">
                        </div>
                        <div class="form-row">
                            <label>N√∫mero *</label>
                            <input type="text" id="clienteNumero" placeholder="123">
                        </div>
                        <div class="form-row">
                            <label>Bairro *</label>
                            <input type="text" id="clienteBairro" placeholder="Seu bairro">
                        </div>
                    </div>

                    <div class="form-row">
                        <label>üìç Complemento</label>
                        <input type="text" id="clienteComplemento" placeholder="Apto, Bloco, Refer√™ncia...">
                    </div>

                    <div class="frete-info" id="freteInfo">
                        üëÜ Informe seu CEP
                    </div>
                </div>

                <div id="pickupFields">
                    <div class="form-row">
                        <label>üë§ Nome completo *</label>
                        <input type="text" id="pickupNome" placeholder="Digite seu nome">
                    </div>
                    <div class="form-row">
                        <label>üì± WhatsApp *</label>
                        <input type="tel" id="pickupTelefone" placeholder="(51) 99999-9999">
                    </div>
                </div>

                <!-- CAMPOS DE AGENDAMENTO -->
                <div id="agendamentoFields" style="display: none;">
                    <div class="form-section" style="background: #fff3e0; margin-top: 15px;">
                        <h3>üìÖ Agendar Entrega</h3>
                        <div class="form-row">
                            <label>Data para entrega</label>
                            <input type="date" id="dataAgendamento" min="" onchange="carregarHorariosPorData()">
                        </div>
                        <div class="form-row">
                            <label>Hor√°rio</label>
                            <select id="horarioAgendamento">
                                <option value="">Primeiro selecione uma data</option>
                            </select>
                        </div>
                        <div class="info-box" style="margin-top: 10px;">
                            ‚è∞ Seu pedido ser√° entregue no per√≠odo agendado. Qualquer altera√ß√£o nossa equipe entra em contato com voc√™!
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label>üìù Observa√ß√µes</label>
                    <textarea id="observacoes" rows="2" placeholder="Ex: ponto da carne, tirar cebola..."></textarea>
                </div>
            </div>

            <button class="whatsapp-btn" onclick="finalizarPedido()">
                üì≤ Finalizar Pedido
            </button>
        </div>
    </div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const API_URL = 'https://meu-pedido-backend.onrender.com/api';
        const SUBDOMINIO = 'dlcrepes';
        
        // ===== VARI√ÅVEIS GLOBAIS =====
        let produtos = [];
        let carrinho = [];
        let categoriaAtiva = 'Todos';
        let produtosFiltrados = [];
        let configuracoesLoja = {};
        let taxaFrete = 0;
        let distanciaKm = 0;
        let horariosDelivery = [];
        let modoAgendamento = false;
        let cepValido = false;
        let dentroAreaEntrega = false;
        let disponibilidadeDelivery = { disponivel: true, mensagem: '' };

        console.log('üöÄ Frontend iniciado');
        console.log('üì° API_URL:', API_URL);

        // ===== CARREGAR CONFIGURA√á√ïES DA LOJA =====
        async function carregarConfiguracoes() {
            try {
                const response = await fetch(`${API_URL}/config/${SUBDOMINIO}`);
                configuracoesLoja = await response.json();
                
                document.getElementById('nomeLoja').textContent = configuracoesLoja.nome_loja || 'DL Crepes e Lanches';
                document.getElementById('slogan').textContent = configuracoesLoja.slogan || 'Seu ref√∫gio de sabores';
                document.getElementById('horario').innerHTML = `üïí ${configuracoesLoja.horario_funcionamento || '18h √†s 23h'}`;
                document.getElementById('endereco').innerHTML = `üìç ${configuracoesLoja.endereco_completo || 'Santa Marta'}`;
                
                exibirMensagemPersonalizada();
                
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }

        // ===== EXIBIR MENSAGEM PERSONALIZADA =====
        function exibirMensagemPersonalizada() {
            const antiga = document.querySelector('.mensagem-personalizada');
            if (antiga) antiga.remove();
            
            if (configuracoesLoja?.mensagem_banner_ativo && configuracoesLoja.mensagem_banner) {
                const header = document.querySelector('.header');
                if (!header) return;
                
                const div = document.createElement('div');
                div.className = 'mensagem-personalizada';
                div.style.backgroundColor = configuracoesLoja.mensagem_banner_cor || '#FFF3E0';
                div.style.color = configuracoesLoja.mensagem_banner_texto || '#E65100';
                div.innerHTML = `
                    <span style="font-size:20px">${configuracoesLoja.mensagem_banner_icone || 'üì¢'}</span>
                    <span>${configuracoesLoja.mensagem_banner}</span>
                `;
                header.parentNode.insertBefore(div, header.nextSibling);
            }
        }

        // ===== CARREGAR HOR√ÅRIOS =====
        async function carregarHorarios() {
            try {
                const response = await fetch(`${API_URL}/horarios/${SUBDOMINIO}`);
                horariosDelivery = await response.json();
                console.log('üìÖ Hor√°rios carregados:', horariosDelivery);
                
                verificarDisponibilidadeDelivery();
            } catch (error) {
                console.error('Erro ao carregar hor√°rios:', error);
                horariosDelivery = [
                    { dia_semana: 0, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 1, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 2, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 3, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 4, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 5, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 6, aberto: true, abertura: '18:00', fechamento: '23:00' }
                ];
                verificarDisponibilidadeDelivery();
            }
        }

        // ===== VERIFICAR DISPONIBILIDADE DO DELIVERY =====
        function verificarDisponibilidadeDelivery() {
            const agora = new Date();
            const diaSemana = agora.getDay();
            const horaAtual = agora.getHours() * 60 + agora.getMinutes();
            
            const horarioHoje = horariosDelivery.find(h => h.dia_semana === diaSemana);
            
            if (!horarioHoje || !horarioHoje.aberto) {
                disponibilidadeDelivery = { 
                    disponivel: false, 
                    mensagem: 'üö´ Nosso delivery n√£o est√° dispon√≠vel hoje' 
                };
                return disponibilidadeDelivery;
            }
            
            const abertura = horaParaMinutos(horarioHoje.abertura);
            const fechamento = horaParaMinutos(horarioHoje.fechamento);
            
            if (horaAtual >= abertura && horaAtual <= fechamento) {
                disponibilidadeDelivery = { 
                    disponivel: true, 
                    mensagem: '‚úÖ Delivery dispon√≠vel agora',
                    horario: `${horarioHoje.abertura} √†s ${horarioHoje.fechamento}`
                };
            } else {
                disponibilidadeDelivery = { 
                    disponivel: false, 
                    mensagem: `‚è∞ Delivery indispon√≠vel agora. Hor√°rio: ${horarioHoje.abertura} √†s ${horarioHoje.fechamento}`,
                    horario: `${horarioHoje.abertura} √†s ${horarioHoje.fechamento}`
                };
            }
            
            return disponibilidadeDelivery;
        }

        function horaParaMinutos(hora) {
            if (!hora) return 0;
            const [h, m] = hora.split(':').map(Number);
            return h * 60 + (m || 0);
        }

        // ===== CARREGAR HOR√ÅRIOS POR DATA =====
        function carregarHorariosPorData() {
            const dataSelecionada = document.getElementById('dataAgendamento').value;
            const select = document.getElementById('horarioAgendamento');
            
            if (!dataSelecionada) {
                select.innerHTML = '<option value="">Selecione uma data primeiro</option>';
                return;
            }
            
            const data = new Date(dataSelecionada + 'T12:00:00');
            const diaSemana = data.getDay();
            
            const horarioDia = horariosDelivery.find(h => h.dia_semana === diaSemana);
            
            if (!horarioDia || !horarioDia.aberto) {
                select.innerHTML = '<option value="">N√£o h√° entregas neste dia</option>';
                return;
            }
            
            const [horaAbertura, minAbertura] = horarioDia.abertura.split(':').map(Number);
            const [horaFechamento, minFechamento] = horarioDia.fechamento.split(':').map(Number);
            
            const aberturaTotal = horaAbertura * 60 + (minAbertura || 0);
            const fechamentoTotal = horaFechamento * 60 + (minFechamento || 0);
            
            const periodos = [];
            for (let minutos = aberturaTotal; minutos < fechamentoTotal; minutos += 60) {
                const horaInicio = Math.floor(minutos / 60);
                const minInicio = minutos % 60;
                const horaFim = Math.floor((minutos + 60) / 60);
                const minFim = (minutos + 60) % 60;
                
                const inicioFormatado = `${horaInicio.toString().padStart(2, '0')}:${minInicio.toString().padStart(2, '0')}`;
                const fimFormatado = `${horaFim.toString().padStart(2, '0')}:${minFim.toString().padStart(2, '0')}`;
                
                periodos.push({
                    inicio: inicioFormatado,
                    fim: fimFormatado,
                    label: `${inicioFormatado} - ${fimFormatado}`
                });
            }
            
            select.innerHTML = '<option value="">Selecione um hor√°rio</option>';
            
            const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const nomeDia = diasSemana[diaSemana];
            const dataFormatada = data.toLocaleDateString('pt-BR');
            
            periodos.forEach(periodo => {
                const option = document.createElement('option');
                option.value = `${dataSelecionada}|${periodo.inicio}|${periodo.fim}`;
                option.textContent = `${nomeDia}, ${dataFormatada}, entre ${periodo.label}`;
                select.appendChild(option);
            });
        }

        // ===== M√ÅSCARA PARA CEP =====
        function mascaraCEP(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length > 5) {
                valor = valor.substring(0,5) + '-' + valor.substring(5,8);
            }
            input.value = valor;
            
            const cepNumerico = valor.replace(/\D/g, '');
            if (cepNumerico.length === 8) {
                clearTimeout(window.timerCEP);
                window.timerCEP = setTimeout(() => {
                    calcularFretePorCEP();
                }, 500);
            }
        }

        // ===== RESETAR ESTADOS DO CEP =====
        function resetarEstadosCEP() {
            cepValido = false;
            dentroAreaEntrega = false;
            
            document.getElementById('freteInfo').innerHTML = 'üëÜ Informe seu CEP';
            document.getElementById('freteInfo').className = 'frete-info';
            document.getElementById('avisoDelivery').style.display = 'none';
            
            calcularTotal();
        }

        // ===== CALCULAR FRETE POR CEP =====
        async function calcularFretePorCEP() {
            const cepInput = document.getElementById('cepInput');
            const cep = cepInput.value.replace(/\D/g, '');
            
            resetarEstadosCEP();
            
            if (cep.length !== 8) {
                document.getElementById('cepInfo').innerHTML = '‚ùå CEP inv√°lido (8 n√∫meros)';
                return;
            }

            document.getElementById('cepInfo').innerHTML = 'üîÑ Buscando CEP...';
            
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const dados = await res.json();
                
                if (dados.erro) {
                    document.getElementById('cepInfo').innerHTML = '‚ùå CEP n√£o encontrado';
                    return;
                }
                
                document.getElementById('clienteEndereco').value = dados.logradouro || '';
                document.getElementById('clienteBairro').value = dados.bairro || '';
                document.getElementById('cepInfo').innerHTML = '‚úÖ CEP v√°lido';
                
                cepValido = true;
                
                const cepLoja = configuracoesLoja.cep_loja?.replace(/\D/g, '') || '97000000';
                const diferenca = Math.abs(parseInt(cep.substring(0, 5)) - parseInt(cepLoja.substring(0, 5)));
                distanciaKm = diferenca / 100;
                if (distanciaKm < 3) distanciaKm = 3;
                
                const kmMax = configuracoesLoja.km_maximo_entrega || 30;
                
                if (distanciaKm > kmMax) {
                    dentroAreaEntrega = false;
                    document.getElementById('freteInfo').innerHTML = `‚ùå Fora da √°rea de entrega (${distanciaKm.toFixed(1)} km)`;
                    document.getElementById('freteInfo').className = 'frete-info erro';
                    
                    mostrarAviso(
                        'endereco', 
                        'üö´ Nosso delivery n√£o atende seu endere√ßo', 
                        'retirar'
                    );
                    return;
                }
                
                dentroAreaEntrega = true;
                
                const taxaKm = configuracoesLoja.taxa_por_km || 2;
                const taxaMin = configuracoesLoja.taxa_minima || 5;
                let frete = distanciaKm * taxaKm;
                if (frete < taxaMin) frete = taxaMin;
                
                taxaFrete = frete;
                
                const subtotal = carrinho.reduce((s, i) => s + i.preco, 0);
                if (subtotal >= (configuracoesLoja.frete_gratis_acima || 50)) {
                    taxaFrete = 0;
                    document.getElementById('freteInfo').innerHTML = 'üéâ Frete gr√°tis!';
                    document.getElementById('freteInfo').className = 'frete-info';
                } else {
                    document.getElementById('freteInfo').innerHTML = `üöö R$ ${taxaFrete.toFixed(2)} (${distanciaKm.toFixed(1)} km)`;
                    document.getElementById('freteInfo').className = 'frete-info';
                }
                
                calcularTotal();
                
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                document.getElementById('cepInfo').innerHTML = '‚ùå Erro ao buscar CEP';
            }
        }

        // ===== CARREGAR PRODUTOS =====
        async function carregarProdutos() {
            try {
                const response = await fetch(`${API_URL}/cardapio/${SUBDOMINIO}`, {
                    cache: 'no-store',
                    headers: { 'Pragma': 'no-cache' }
                });
                
                if (!response.ok) throw new Error('Erro na rede');
                
                const novosProdutos = await response.json();
                
                if (JSON.stringify(produtos) !== JSON.stringify(novosProdutos)) {
                    console.log('üîÑ Card√°pio atualizado');
                    produtos = novosProdutos;
                    produtosFiltrados = produtos;
                    exibirProdutos();
                    carregarCategorias();
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                document.getElementById('produtos').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: red;">
                        ‚ùå Erro ao carregar card√°pio
                    </div>
                `;
            }
        }

        // ===== CARREGAR CATEGORIAS =====
        function carregarCategorias() {
            const cats = ['Todos', ...new Set(produtos.map(p => p.categoria_nome))];
            document.getElementById('categorias').innerHTML = cats.map(c => 
                `<button class="categoria-btn ${c === categoriaAtiva ? 'ativa' : ''}" onclick="filtrarCategoria('${c}')">${c}</button>`
            ).join('');
        }

        // ===== FILTRAR POR CATEGORIA =====
        function filtrarCategoria(categoria) {
            categoriaAtiva = categoria;
            carregarCategorias();
            filtrarProdutos();
        }

        // ===== FILTRAR POR BUSCA E CATEGORIA =====
        function filtrarProdutos() {
            const busca = document.getElementById('searchInput').value.toLowerCase();
            produtosFiltrados = produtos.filter(p => 
                (categoriaAtiva === 'Todos' || p.categoria_nome === categoriaAtiva) &&
                p.nome.toLowerCase().includes(busca)
            );
            exibirProdutos();
        }

        // ===== EXIBIR PRODUTOS =====
        function exibirProdutos() {
            if (produtosFiltrados.length === 0) {
                document.getElementById('produtos').innerHTML = '<div style="padding:20px">Nenhum produto encontrado</div>';
                return;
            }
            
            document.getElementById('produtos').innerHTML = produtosFiltrados.map(p => `
                <div class="produto-card">
                    <div>
                        <h3>${p.nome}</h3>
                        <div class="produto-preco">R$ ${parseFloat(p.preco).toFixed(2)}</div>
                    </div>
                    <button class="btn-adicionar" onclick="adicionarAoCarrinho(${p.id}, '${p.nome.replace(/'/g, "\\'")}', ${p.preco})">+</button>
                </div>
            `).join('');
        }

        // ===== CARRINHO =====
        function adicionarAoCarrinho(id, nome, preco) {
            carrinho.push({ id, nome, preco });
            document.getElementById('cartCount').textContent = carrinho.length;
            alert('‚úÖ Adicionado ao carrinho');
        }

        function removerDoCarrinho(index) {
            carrinho.splice(index, 1);
            document.getElementById('cartCount').textContent = carrinho.length;
            abrirCarrinho();
        }

        function atualizarCarrinho() {
            document.getElementById('cartCount').textContent = carrinho.length;
        }

        // ===== MODAL DO CARRINHO =====
        function abrirCarrinho() {
            modoAgendamento = false;
            cepValido = false;
            dentroAreaEntrega = false;
            document.getElementById('agendamentoFields').style.display = 'none';
            document.getElementById('avisoDelivery').style.display = 'none';
            
            document.getElementById('deliveryOption').checked = false;
            document.getElementById('pickupOption').checked = true;
            toggleDelivery(false);
            
            if (carrinho.length === 0) {
                document.getElementById('cartItems').innerHTML = '<div style="padding:20px">üõí Carrinho vazio</div>';
                document.getElementById('cartTotal').textContent = '0,00';
            } else {
                document.getElementById('cartItems').innerHTML = carrinho.map((item, index) => `
                    <div class="cart-item">
                        <div>
                            <div class="cart-item-name">${item.nome}</div>
                            <div class="cart-item-price">R$ ${item.preco.toFixed(2)}</div>
                        </div>
                        <button class="cart-item-remove" onclick="removerDoCarrinho(${index})">√ó</button>
                    </div>
                `).join('');
                calcularTotal();
            }
            
            document.getElementById('cartModal').style.display = 'block';
        }

        function fecharCarrinho() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function toggleDelivery(isDelivery) {
            document.getElementById('deliveryFields').style.display = isDelivery ? 'block' : 'none';
            document.getElementById('pickupFields').style.display = isDelivery ? 'none' : 'block';
            document.getElementById('agendamentoFields').style.display = 'none';
            document.getElementById('avisoDelivery').style.display = 'none';
            
            if (isDelivery) {
                const status = verificarDisponibilidadeDelivery();
                
                if (!status.disponivel) {
                    mostrarAviso(
                        'horario', 
                        status.mensagem, 
                        'agendar'
                    );
                } else {
                    document.getElementById('freteInfo').innerHTML = `‚úÖ Delivery dispon√≠vel (${status.horario})`;
                }
            } else {
                taxaFrete = 0;
                distanciaKm = 0;
                cepValido = false;
                dentroAreaEntrega = false;
                calcularTotal();
            }
        }

        function mostrarAviso(tipo, mensagem, acao) {
            const avisoDiv = document.getElementById('avisoDelivery');
            if (!avisoDiv) return;
            
            let botoes = '';
            if (acao === 'agendar') {
                botoes = `
                    <div class="botoes-aviso">
                        <button class="btn-aviso agendar" onclick="mostrarAgendamento()">üìÖ Quero agendar entrega</button>
                        <button class="btn-aviso retirar" onclick="selecionarRetirada()">üè† Quero retirar agora</button>
                    </div>
                `;
            } else if (acao === 'retirar') {
                botoes = `
                    <div class="botoes-aviso">
                        <button class="btn-aviso retirar" onclick="selecionarRetirada()">üè† Quero retirar agora</button>
                    </div>
                `;
            }
            
            avisoDiv.innerHTML = `
                <p style="font-weight: bold; margin-bottom: 10px;">${mensagem}</p>
                ${botoes}
            `;
            avisoDiv.style.display = 'block';
        }

        function mostrarAgendamento() {
            document.getElementById('avisoDelivery').style.display = 'none';
            document.getElementById('agendamentoFields').style.display = 'block';
            modoAgendamento = true;
            
            document.getElementById('dataAgendamento').value = '';
            document.getElementById('horarioAgendamento').innerHTML = '<option value="">Selecione uma data primeiro</option>';
            
            const hoje = new Date();
            const amanha = new Date(hoje);
            amanha.setDate(hoje.getDate() + 1);
            const dataMin = amanha.toISOString().split('T')[0];
            document.getElementById('dataAgendamento').min = dataMin;
        }

        function selecionarRetirada() {
            document.getElementById('avisoDelivery').style.display = 'none';
            document.getElementById('deliveryOption').checked = false;
            document.getElementById('pickupOption').checked = true;
            toggleDelivery(false);
        }

        function calcularTotal() {
            const subtotal = carrinho.reduce((s, i) => s + i.preco, 0);
            document.getElementById('cartTotal').textContent = (subtotal + taxaFrete).toFixed(2);
        }

        function abrirWhatsappSuporte() {
            const numero = configuracoesLoja.whatsapp || '5551999999999';
            window.open(`https://wa.me/${numero}?text=${encodeURIComponent('Preciso de ajuda')}`, '_blank');
        }

        // ===== FINALIZAR PEDIDO =====
        async function finalizarPedido() {
            if (carrinho.length === 0) {
                alert('‚ùå Carrinho vazio');
                return;
            }

            const tipo = document.querySelector('input[name="deliveryType"]:checked')?.value;
            
            if (!tipo) {
                alert('Selecione uma op√ß√£o de entrega');
                return;
            }
            
            let nome, tel;
            let dadosPedido = {};
            let infoAgendamento = '';
            
            if (tipo === 'delivery') {
                nome = document.getElementById('clienteNome').value;
                tel = document.getElementById('clienteTelefone').value;
                const endereco = document.getElementById('clienteEndereco').value;
                const numero = document.getElementById('clienteNumero').value;
                const bairro = document.getElementById('clienteBairro').value;
                const cep = document.getElementById('cepInput').value;
                const complemento = document.getElementById('clienteComplemento').value;
                
                if (!nome || !tel || !endereco || !numero || !bairro || !cep) {
                    alert('Preencha todos os campos obrigat√≥rios para delivery');
                    return;
                }
                
                if (!dentroAreaEntrega) {
                    alert('Seu endere√ßo n√£o √© atendido pelo delivery. Escolha a op√ß√£o Retirada.');
                    return;
                }
                
                const status = verificarDisponibilidadeDelivery();
                
                if (!status.disponivel && !modoAgendamento) {
                    alert('Delivery indispon√≠vel agora. Use a op√ß√£o "Quero agendar entrega" acima.');
                    return;
                }
                
                const enderecoCompleto = `${endereco}, ${numero}`;
                const enderecoComCep = `${enderecoCompleto}${complemento ? ' - ' + complemento : ''} - CEP: ${cep}`;
                
                dadosPedido = {
                    cliente_nome: nome,
                    cliente_telefone: tel,
                    cliente_endereco: enderecoComCep,
                    cliente_bairro: bairro,
                    cliente_cep: cep,
                    tipo_entrega: tipo,
                    taxa_entrega: taxaFrete,
                    subtotal: carrinho.reduce((s, i) => s + i.preco, 0),
                    total: carrinho.reduce((s, i) => s + i.preco, 0) + taxaFrete,
                    observacoes: document.getElementById('observacoes').value,
                    itens: carrinho.map(i => ({
                        produto_id: i.id,
                        produto_nome: i.nome,
                        quantidade: 1,
                        preco_unitario: i.preco,
                        subtotal: i.preco
                    }))
                };
                
                if (modoAgendamento) {
                    const dataAgendamento = document.getElementById('dataAgendamento').value;
                    const horarioAgendamento = document.getElementById('horarioAgendamento').value;
                    
                    if (!dataAgendamento || !horarioAgendamento) {
                        alert('Selecione data e hor√°rio para o agendamento');
                        return;
                    }
                    
                    const [dataStr, horaInicio, horaFim] = horarioAgendamento.split('|');
                    const dataFormatada = new Date(dataStr).toLocaleDateString('pt-BR');
                    infoAgendamento = `\nüìÖ Entrega agendada: ${dataFormatada}, entre ${horaInicio} e ${horaFim}`;
                    dadosPedido.observacoes += `\n[AGENDADO] ${dataFormatada} - Per√≠odo: ${horaInicio} √†s ${horaFim}`;
                }
            } else {
                nome = document.getElementById('pickupNome').value;
                tel = document.getElementById('pickupTelefone').value;
                
                if (!nome || !tel) {
                    alert('Preencha nome e telefone para retirada');
                    return;
                }
                
                dadosPedido = {
                    cliente_nome: nome,
                    cliente_telefone: tel,
                    tipo_entrega: tipo,
                    taxa_entrega: 0,
                    subtotal: carrinho.reduce((s, i) => s + i.preco, 0),
                    total: carrinho.reduce((s, i) => s + i.preco, 0),
                    observacoes: document.getElementById('observacoes').value,
                    itens: carrinho.map(i => ({
                        produto_id: i.id,
                        produto_nome: i.nome,
                        quantidade: 1,
                        preco_unitario: i.preco,
                        subtotal: i.preco
                    }))
                };
            }

            try {
                console.log('üíæ Salvando pedido...', dadosPedido);
                
                const response = await fetch(`${API_URL}/pedidos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subdominio: SUBDOMINIO, pedido: dadosPedido })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Pedido salvo no banco');
                } else {
                    console.error('‚ùå Erro ao salvar no banco');
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
            }

            let msg = `*NOVO PEDIDO*\n----------------\n`;
            msg += `Cliente: ${nome}\n`;
            msg += `Contato: ${tel}\n`;
            if (infoAgendamento) msg += infoAgendamento + '\n';
            msg += `\nITENS:\n`;
            
            carrinho.forEach(i => {
                msg += `- ${i.nome}: R$ ${i.preco.toFixed(2)}\n`;
            });
            
            const subtotal = carrinho.reduce((s, i) => s + i.preco, 0);
            msg += `\nSubtotal: R$ ${subtotal.toFixed(2)}`;
            
            if (tipo === 'delivery') {
                msg += `\nFrete: ${taxaFrete > 0 ? 'R$ ' + taxaFrete.toFixed(2) : 'GR√ÅTIS'}`;
                
                const endereco = document.getElementById('clienteEndereco').value;
                const numero = document.getElementById('clienteNumero').value;
                const bairro = document.getElementById('clienteBairro').value;
                const complemento = document.getElementById('clienteComplemento').value;
                const cep = document.getElementById('cepInput').value;
                
                msg += `\nEndere√ßo: ${endereco}, ${numero}`;
                if (complemento) msg += ` - ${complemento}`;
                msg += `\nBairro: ${bairro}`;
                msg += `\nCEP: ${cep}`;
            } else {
                msg += `\nRetirada no local`;
            }
            
            const total = subtotal + (tipo === 'delivery' ? taxaFrete : 0);
            msg += `\n\nTOTAL: R$ ${total.toFixed(2)}`;
            
            if (dadosPedido.observacoes) {
                msg += `\n\nObs: ${dadosPedido.observacoes}`;
            }

            window.open(`https://wa.me/${configuracoesLoja.whatsapp || '5551999999999'}?text=${encodeURIComponent(msg)}`, '_blank');
            
            carrinho = [];
            document.getElementById('cartCount').textContent = '0';
            fecharCarrinho();
        }

        // ===== INICIALIZAR =====
        window.onload = async () => {
            await carregarConfiguracoes();
            await carregarHorarios();
            await carregarProdutos();
        };
    </script>
</body>
</html>