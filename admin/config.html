<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Meu Pedido</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .config-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .config-section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #C83232;
        }
        
        .btn-save {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .btn-save:hover {
            background: #388E3C;
        }
        
        .mensagem-preview {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .horarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .dia-card {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
        }
        
        .dia-card h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 16px;
        }
        
        .horario-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .horario-inputs input[type="time"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            border-radius: 4px;
        }
        
        .success-message {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .warning-message {
            background: #ff9800;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #C83232;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>üçΩÔ∏è Meu Pedido - Painel Administrativo</h1>
        <div class="user-info">
            <span>üë§ DL Crepes e Lanches</span>
            <button class="logout" onclick="logout()">üö™ Sair</button>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="admin-sidebar">
            <ul>
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="produtos.html">üì¶ Produtos</a></li>
                <li><a href="categorias.html">üìÅ Categorias</a></li>
                <li><a href="pedidos.html">üìã Pedidos</a></li>
                <li><a href="config.html" class="active">‚öôÔ∏è Configura√ß√µes</a></li>
            </ul>
        </div>
        
        <div class="admin-content">
            <h1>‚öôÔ∏è Configura√ß√µes da Loja</h1>
            
            <div id="successMessage" class="success-message"></div>
            <div id="warningMessage" class="warning-message"></div>
            <div id="errorMessage" class="error-message"></div>
            
            <div id="configContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Carregando configura√ß√µes...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://meu-pedido-backend.onrender.com/api';
        const SUBDOMINIO = 'dlcrepes';
        
        let configuracoes = {};
        let horariosDelivery = [];

        // Verificar login
        if (!localStorage.getItem('adminLogado')) {
            window.location.href = 'index.html';
        }

        function logout() {
            localStorage.removeItem('adminLogado');
            window.location.href = 'index.html';
        }

        function mostrarMensagem(tipo, texto) {
            const success = document.getElementById('successMessage');
            const warning = document.getElementById('warningMessage');
            const error = document.getElementById('errorMessage');
            
            // Esconder todos
            success.style.display = 'none';
            warning.style.display = 'none';
            error.style.display = 'none';
            
            if (tipo === 'success') {
                success.textContent = texto;
                success.style.display = 'block';
                setTimeout(() => { success.style.display = 'none'; }, 5000);
            } else if (tipo === 'warning') {
                warning.textContent = texto;
                warning.style.display = 'block';
                setTimeout(() => { warning.style.display = 'none'; }, 5000);
            } else {
                error.textContent = texto;
                error.style.display = 'block';
                setTimeout(() => { error.style.display = 'none'; }, 5000);
            }
        }

        async function carregarConfiguracoes() {
            try {
                console.log('üîÑ Carregando configura√ß√µes...');
                
                // Carregar configura√ß√µes da loja
                const configResponse = await fetch(`${API_URL}/config/${SUBDOMINIO}`);
                if (!configResponse.ok) throw new Error('Erro ao carregar configura√ß√µes');
                configuracoes = await configResponse.json();
                console.log('‚úÖ Configura√ß√µes carregadas:', configuracoes);
                
                // Carregar hor√°rios do delivery
                try {
                    const horariosResponse = await fetch(`${API_URL}/horarios/${SUBDOMINIO}`);
                    if (horariosResponse.ok) {
                        const data = await horariosResponse.json();
                        horariosDelivery = Array.isArray(data) ? data : [];
                        console.log('‚úÖ Hor√°rios carregados:', horariosDelivery);
                    } else {
                        console.log('‚ö†Ô∏è Usando hor√°rios padr√£o (API n√£o respondeu)');
                        horariosDelivery = [
                            { dia_semana: 0, aberto: true, abertura: '18:00', fechamento: '23:00' },
                            { dia_semana: 1, aberto: true, abertura: '18:00', fechamento: '23:00' },
                            { dia_semana: 2, aberto: true, abertura: '18:00', fechamento: '23:00' },
                            { dia_semana: 3, aberto: true, abertura: '18:00', fechamento: '23:00' },
                            { dia_semana: 4, aberto: true, abertura: '18:00', fechamento: '23:00' },
                            { dia_semana: 5, aberto: true, abertura: '18:00', fechamento: '23:00' },
                            { dia_semana: 6, aberto: true, abertura: '18:00', fechamento: '23:00' }
                        ];
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Erro ao carregar hor√°rios, usando padr√£o:', error.message);
                    horariosDelivery = [
                        { dia_semana: 0, aberto: true, abertura: '18:00', fechamento: '23:00' },
                        { dia_semana: 1, aberto: true, abertura: '18:00', fechamento: '23:00' },
                        { dia_semana: 2, aberto: true, abertura: '18:00', fechamento: '23:00' },
                        { dia_semana: 3, aberto: true, abertura: '18:00', fechamento: '23:00' },
                        { dia_semana: 4, aberto: true, abertura: '18:00', fechamento: '23:00' },
                        { dia_semana: 5, aberto: true, abertura: '18:00', fechamento: '23:00' },
                        { dia_semana: 6, aberto: true, abertura: '18:00', fechamento: '23:00' }
                    ];
                }
                
                exibirFormulario();
            } catch (error) {
                console.error('‚ùå Erro fatal:', error);
                document.getElementById('configContainer').innerHTML = `
                    <div style="text-align:center; padding:40px; color:red;">
                        ‚ùå Erro ao carregar configura√ß√µes: ${error.message}<br>
                        <button onclick="carregarConfiguracoes()" style="margin-top:20px; padding:10px 20px; background:#C83232; color:white; border:none; border-radius:5px; cursor:pointer;">
                            üîÑ Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        function exibirFormulario() {
            const dias = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            
            // Garantir que horariosDelivery √© um array
            const horariosParaExibir = Array.isArray(horariosDelivery) && horariosDelivery.length > 0 
                ? horariosDelivery 
                : [
                    { dia_semana: 0, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 1, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 2, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 3, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 4, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 5, aberto: true, abertura: '18:00', fechamento: '23:00' },
                    { dia_semana: 6, aberto: true, abertura: '18:00', fechamento: '23:00' }
                ];
            
            // Gerar HTML dos hor√°rios
            const horariosHtml = horariosParaExibir.map(h => {
                const diaSemana = h.dia_semana !== undefined ? h.dia_semana : 0;
                const aberto = h.aberto !== undefined ? h.aberto : true;
                const abertura = h.abertura || '18:00';
                const fechamento = h.fechamento || '23:00';
                
                return `
                    <div class="dia-card">
                        <h4>
                            ${dias[diaSemana] || 'Dia'}
                            <label class="toggle-switch">
                                <input type="checkbox" class="horario-checkbox" data-dia="${diaSemana}" ${aberto ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </h4>
                        <div class="horario-inputs">
                            <input type="time" class="horario-abertura" data-dia="${diaSemana}" value="${abertura}" ${!aberto ? 'disabled' : ''}>
                            <span>at√©</span>
                            <input type="time" class="horario-fechamento" data-dia="${diaSemana}" value="${fechamento}" ${!aberto ? 'disabled' : ''}>
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <form id="configForm" onsubmit="event.preventDefault(); salvarConfiguracoes()">
                    <!-- DADOS DA LOJA -->
                    <div class="config-section">
                        <h2>üè™ Dados da Loja</h2>
                        
                        <div class="form-group">
                            <label>Nome da Loja</label>
                            <input type="text" id="nome_loja" value="${configuracoes.nome_loja || ''}" placeholder="DL Crepes e Lanches">
                        </div>
                        
                        <div class="form-group">
                            <label>Slogan</label>
                            <input type="text" id="slogan" value="${configuracoes.slogan || ''}" placeholder="Seu ref√∫gio de sabores">
                        </div>
                        
                        <div class="form-group">
                            <label>WhatsApp (com DDD)</label>
                            <input type="text" id="whatsapp" value="${configuracoes.whatsapp || ''}" placeholder="5551999999999">
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo Completo</label>
                            <textarea id="endereco_completo" rows="2" placeholder="Bairro Santa Marta, Santa Maria - RS">${configuracoes.endereco_completo || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>CEP da Loja</label>
                            <input type="text" id="cep_loja" value="${configuracoes.cep_loja || ''}" placeholder="00000-000">
                        </div>
                        
                        <div class="form-group">
                            <label>Cor Principal</label>
                            <input type="color" id="cor_principal" value="${configuracoes.cor_principal || '#C83232'}">
                        </div>
                    </div>

                    <!-- HOR√ÅRIO DE FUNCIONAMENTO DA LOJA -->
                    <div class="config-section">
                        <h2>‚è∞ Hor√°rio de Funcionamento da Loja</h2>
                        <div class="info-box">
                            ‚ÑπÔ∏è Este hor√°rio ser√° exibido no card√°pio para os clientes.
                        </div>
                        <div class="form-group">
                            <label>Hor√°rio de Funcionamento (texto livre)</label>
                            <input type="text" id="horario_funcionamento" value="${configuracoes.horario_funcionamento || 'Seg a Dom: 18h √†s 23h'}" placeholder="Ex: Seg a Dom: 18h √†s 23h">
                        </div>
                    </div>

                    <!-- CONFIGURA√á√ïES DE ENTREGA -->
                    <div class="config-section">
                        <h2>üöö Configura√ß√µes de Entrega</h2>
                        
                        <div class="info-box">
                            ‚ÑπÔ∏è Configure as taxas de entrega e dist√¢ncia m√°xima.
                        </div>
                        
                        <div class="form-group">
                            <label>Taxa por KM (R$)</label>
                            <input type="number" id="taxa_por_km" step="0.01" min="0" value="${configuracoes.taxa_por_km || 2.00}">
                        </div>
                        
                        <div class="form-group">
                            <label>Taxa M√≠nima (R$)</label>
                            <input type="number" id="taxa_minima" step="0.01" min="0" value="${configuracoes.taxa_minima || 5.00}">
                        </div>
                        
                        <div class="form-group">
                            <label>Frete Gr√°tis Acima de (R$)</label>
                            <input type="number" id="frete_gratis_acima" step="0.01" min="0" value="${configuracoes.frete_gratis_acima || 50.00}">
                        </div>
                        
                        <div class="form-group">
                            <label>Dist√¢ncia M√°xima para Entrega (KM)</label>
                            <input type="number" id="km_maximo_entrega" step="0.1" min="0" value="${configuracoes.km_maximo_entrega || 30.00}">
                        </div>
                        
                        <div class="form-group">
                            <label>Mensagem quando fora da √°rea</label>
                            <textarea id="mensagem_km_excedido" rows="2">${configuracoes.mensagem_km_excedido || 'Fora da √°rea de entrega. Escolha retirada.'}</textarea>
                        </div>
                    </div>

                    <!-- HOR√ÅRIOS DO DELIVERY -->
                    <div class="config-section">
                        <h2>‚è∞ Hor√°rios do Delivery</h2>
                        <div class="info-box">
                            üöö Configure os dias e hor√°rios em que o delivery est√° dispon√≠vel.
                            Fora destes hor√°rios, o cliente ver√° op√ß√£o de agendamento.
                        </div>
                        
                        <div class="horarios-grid">
                            ${horariosHtml}
                        </div>
                    </div>

                    <!-- MENSAGEM PERSONALIZADA -->
                    <div class="config-section">
                        <h2>üìù Mensagem Personalizada</h2>
                        
                        <div class="info-box">
                            üì¢ Esta mensagem aparecer√° no topo do card√°pio.
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="banner_ativo" ${configuracoes.mensagem_banner_ativo ? 'checked' : ''}>
                                Ativar mensagem no topo do card√°pio
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>Mensagem</label>
                            <textarea id="banner_mensagem" rows="2" placeholder="Digite sua mensagem...">${configuracoes.mensagem_banner || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>√çcone (emoji)</label>
                            <input type="text" id="banner_icone" value="${configuracoes.mensagem_banner_icone || 'üì¢'}" maxlength="2">
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <div style="flex:1">
                                <label>Cor de Fundo</label>
                                <input type="color" id="banner_cor_fundo" value="${configuracoes.mensagem_banner_cor || '#FFF3E0'}">
                            </div>
                            <div style="flex:1">
                                <label>Cor do Texto</label>
                                <input type="color" id="banner_cor_texto" value="${configuracoes.mensagem_banner_texto || '#E65100'}">
                            </div>
                        </div>
                        
                        <div class="mensagem-preview" id="previewMensagem" style="background:${configuracoes.mensagem_banner_cor || '#FFF3E0'}; color:${configuracoes.mensagem_banner_texto || '#E65100'};">
                            <span id="previewIcone">${configuracoes.mensagem_banner_icone || 'üì¢'}</span>
                            <span id="previewTexto">${configuracoes.mensagem_banner || 'Preview da mensagem'}</span>
                        </div>
                    </div>

                    <button type="submit" class="btn-save">üíæ Salvar Todas as Configura√ß√µes</button>
                </form>
            `;
            
            document.getElementById('configContainer').innerHTML = html;
            
            // Eventos para preview
            document.getElementById('banner_mensagem')?.addEventListener('input', atualizarPreview);
            document.getElementById('banner_icone')?.addEventListener('input', atualizarPreview);
            document.getElementById('banner_cor_fundo')?.addEventListener('input', atualizarPreview);
            document.getElementById('banner_cor_texto')?.addEventListener('input', atualizarPreview);
            
            // Eventos para hor√°rios
            document.querySelectorAll('.horario-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const dia = this.dataset.dia;
                    const abertura = document.querySelector(`.horario-abertura[data-dia="${dia}"]`);
                    const fechamento = document.querySelector(`.horario-fechamento[data-dia="${dia}"]`);
                    
                    if (abertura && fechamento) {
                        abertura.disabled = !this.checked;
                        fechamento.disabled = !this.checked;
                    }
                });
            });
        }

        function atualizarPreview() {
            const preview = document.getElementById('previewMensagem');
            const corFundo = document.getElementById('banner_cor_fundo')?.value || '#FFF3E0';
            const corTexto = document.getElementById('banner_cor_texto')?.value || '#E65100';
            const icone = document.getElementById('banner_icone')?.value || 'üì¢';
            const texto = document.getElementById('banner_mensagem')?.value || 'Preview';
            
            if (preview) {
                preview.style.background = corFundo;
                preview.style.color = corTexto;
                document.getElementById('previewIcone').textContent = icone;
                document.getElementById('previewTexto').textContent = texto;
            }
        }

        async function salvarConfiguracoes() {
            // Mostrar loading
            const btn = document.querySelector('.btn-save');
            const textoOriginal = btn.textContent;
            btn.textContent = 'üíæ Salvando...';
            btn.disabled = true;
            
            // Dados da loja
            const config = {
                nome_loja: document.getElementById('nome_loja').value,
                slogan: document.getElementById('slogan').value,
                horario_funcionamento: document.getElementById('horario_funcionamento').value,
                whatsapp: document.getElementById('whatsapp').value,
                endereco_completo: document.getElementById('endereco_completo').value,
                cep_loja: document.getElementById('cep_loja').value,
                cor_principal: document.getElementById('cor_principal').value,
                taxa_por_km: parseFloat(document.getElementById('taxa_por_km').value) || 2,
                taxa_minima: parseFloat(document.getElementById('taxa_minima').value) || 5,
                frete_gratis_acima: parseFloat(document.getElementById('frete_gratis_acima').value) || 50,
                km_maximo_entrega: parseFloat(document.getElementById('km_maximo_entrega').value) || 30,
                mensagem_km_excedido: document.getElementById('mensagem_km_excedido').value,
                mensagem_banner_ativo: document.getElementById('banner_ativo').checked,
                mensagem_banner: document.getElementById('banner_mensagem').value,
                mensagem_banner_icone: document.getElementById('banner_icone').value,
                mensagem_banner_cor: document.getElementById('banner_cor_fundo').value,
                mensagem_banner_texto: document.getElementById('banner_cor_texto').value
            };

            // Hor√°rios do delivery
            const horarios = [];
            for (let dia = 0; dia < 7; dia++) {
                const checkbox = document.querySelector(`.horario-checkbox[data-dia="${dia}"]`);
                const abertura = document.querySelector(`.horario-abertura[data-dia="${dia}"]`);
                const fechamento = document.querySelector(`.horario-fechamento[data-dia="${dia}"]`);
                
                if (checkbox && abertura && fechamento) {
                    horarios.push({
                        dia_semana: dia,
                        aberto: checkbox.checked,
                        abertura: abertura.value,
                        fechamento: fechamento.value
                    });
                }
            }

            try {
                console.log('üíæ Salvando configura√ß√µes...', config);
                
                // 1. Salvar configura√ß√µes
                const configResponse = await fetch(`${API_URL}/config/${SUBDOMINIO}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                let mensagem = '';
                let tipo = 'success';
                
                if (configResponse.ok) {
                    mensagem = '‚úÖ Configura√ß√µes salvas com sucesso!';
                } else {
                    const erro = await configResponse.json().catch(() => ({}));
                    mensagem = '‚ùå Erro ao salvar configura√ß√µes: ' + (erro.erro || 'Erro desconhecido');
                    tipo = 'error';
                }

                // 2. Tentar salvar hor√°rios (n√£o cr√≠tico)
                try {
                    const horariosResponse = await fetch(`${API_URL}/horarios/${SUBDOMINIO}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ horarios })
                    });
                    
                    if (!horariosResponse.ok && configResponse.ok) {
                        mensagem += ' ‚ö†Ô∏è Hor√°rios n√£o foram salvos (n√£o cr√≠tico)';
                        tipo = 'warning';
                    }
                } catch (horarioError) {
                    console.warn('Erro ao salvar hor√°rios:', horarioError);
                    if (configResponse.ok) {
                        mensagem += ' ‚ö†Ô∏è Hor√°rios n√£o foram salvos (n√£o cr√≠tico)';
                        tipo = 'warning';
                    }
                }

                mostrarMensagem(tipo, mensagem);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar:', error);
                mostrarMensagem('error', '‚ùå Erro de conex√£o: ' + error.message);
            } finally {
                // Restaurar bot√£o
                btn.textContent = textoOriginal;
                btn.disabled = false;
            }
        }

        // Iniciar
        carregarConfiguracoes();
    </script>
</body>
</html>