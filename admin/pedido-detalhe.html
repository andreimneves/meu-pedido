<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhe do Pedido - Meu Pedido</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f5;
        }

        /* HEADER */
        .admin-header {
            background: linear-gradient(135deg, #C83232, #A02828);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout:hover {
            background: rgba(255,255,255,0.3);
        }

        /* CONTAINER PRINCIPAL */
        .admin-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* SIDEBAR */
        .admin-sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            padding: 20px 0;
        }

        .admin-sidebar ul {
            list-style: none;
        }

        .admin-sidebar li {
            margin-bottom: 5px;
        }

        .admin-sidebar a {
            display: block;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .admin-sidebar a:hover {
            background: #f8f8f8;
            border-left-color: #C83232;
            color: #C83232;
        }

        .admin-sidebar a.active {
            background: #f0f0f0;
            border-left-color: #C83232;
            color: #C83232;
            font-weight: 500;
        }

        /* CONTE√öDO PRINCIPAL */
        .admin-content {
            flex: 1;
            padding: 30px;
            background: #f9f9f9;
        }

        .admin-content h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* CARD DE DETALHE */
        .pedido-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .pedido-id {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .pedido-id span {
            color: #C83232;
        }

        .pedido-status {
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-novo { background: #ff9800; color: white; }
        .status-preparando { background: #2196F3; color: white; }
        .status-pronto { background: #4CAF50; color: white; }
        .status-entregue { background: #9C27B0; color: white; }
        .status-cancelado { background: #f44336; color: white; }

        .pedido-data {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }

        /* SE√á√ïES */
        .secao {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .secao h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .info-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        /* TABELA DE ITENS */
        .itens-tabela {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .itens-tabela th {
            text-align: left;
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .itens-tabela td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .itens-tabela tr:last-child td {
            border-bottom: none;
        }

        .total-pedido {
            text-align: right;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .total-pedido .total-label {
            font-size: 16px;
            color: #666;
            margin-right: 15px;
        }

        .total-pedido .total-value {
            font-size: 24px;
            font-weight: 700;
            color: #C83232;
        }

        /* BOT√ïES DE A√á√ÉO */
        .acoes {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #C83232;
            color: white;
        }

        .btn-primary:hover {
            background: #A02828;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #25D366;
            color: white;
        }

        .btn-success:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-voltar {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .btn-voltar:hover {
            background: #e9ecef;
        }

        /* MODAL DO WHATSAPP */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 16px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .modal button {
            width: 100%;
            padding: 12px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* IMPRESS√ÉO */
        @media print {
            .admin-header,
            .admin-sidebar,
            .acoes,
            .btn-voltar {
                display: none;
            }

            .admin-content {
                padding: 0;
                background: white;
            }

            .pedido-card {
                box-shadow: none;
                padding: 20px;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #C83232;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>üçΩÔ∏è Meu Pedido - Painel Administrativo</h1>
        <div class="user-info">
            <span>üë§ DL Crepes e Lanches</span>
            <button class="logout" onclick="logout()">üö™ Sair</button>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="admin-sidebar">
            <ul>
                <li><a href="dashboard.html">üìä Dashboard</a></li>
                <li><a href="produtos.html">üì¶ Produtos</a></li>
                <li><a href="categorias.html">üìÅ Categorias</a></li>
                <li><a href="pedidos.html">üìã Pedidos</a></li>
                <li><a href="config.html">‚öôÔ∏è Configura√ß√µes</a></li>
            </ul>
        </div>
        
        <div class="admin-content">
            <button class="btn-voltar" onclick="voltar()">‚Üê Voltar para Pedidos</button>
            
            <div id="pedidoContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Carregando detalhes do pedido...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp -->
    <div id="whatsappModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h2>üì± Enviar via WhatsApp</h2>
            <input type="text" id="whatsappNumero" placeholder="Digite o n√∫mero (com DDD)" value="55">
            <button onclick="enviarWhatsApp()">Enviar Pedido</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://meu-pedido-backend.onrender.com/api';
        const SUBDOMINIO = 'dlcrepes';
        
        let pedidoAtual = null;
        let configuracoesLoja = {};

        // Verificar login
        if (!localStorage.getItem('adminLogado')) {
            window.location.href = 'index.html';
        }

        function logout() {
            localStorage.removeItem('adminLogado');
            window.location.href = 'index.html';
        }

        function voltar() {
            window.location.href = 'pedidos.html';
        }

        function getParametroId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        async function carregarPedido() {
            const pedidoId = getParametroId();
            
            if (!pedidoId) {
                document.getElementById('pedidoContainer').innerHTML = `
                    <div style="text-align:center; padding:40px; color:red;">
                        ‚ùå ID do pedido n√£o encontrado
                    </div>
                `;
                return;
            }

            try {
                console.log(`üîÑ Carregando pedido #${pedidoId}...`);
                
                // Carregar configura√ß√µes da loja (para o WhatsApp)
                const configResponse = await fetch(`${API_URL}/config/${SUBDOMINIO}`);
                configuracoesLoja = await configResponse.json();
                
                // Carregar pedido
                const response = await fetch(`${API_URL}/pedidos/${SUBDOMINIO}/${pedidoId}`);
                
                if (!response.ok) {
                    throw new Error('Pedido n√£o encontrado');
                }
                
                pedidoAtual = await response.json();
                console.log('‚úÖ Pedido carregado:', pedidoAtual);
                
                exibirPedido();
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                document.getElementById('pedidoContainer').innerHTML = `
                    <div style="text-align:center; padding:40px; color:red;">
                        ‚ùå Erro ao carregar pedido: ${error.message}
                    </div>
                `;
            }
        }

        function formatarData(data) {
            return new Date(data).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function exibirPedido() {
            const p = pedidoAtual;
            const dataFormatada = formatarData(p.data_pedido);
            
            const enderecoCompleto = p.cliente_endereco || '';
            const bairro = p.cliente_bairro || '';
            
            // Gerar HTML dos itens
            const itensHtml = p.itens.map(item => `
                <tr>
                    <td>${item.produto_nome}</td>
                    <td>${item.quantidade}</td>
                    <td>R$ ${parseFloat(item.preco_unitario).toFixed(2)}</td>
                    <td>R$ ${parseFloat(item.subtotal).toFixed(2)}</td>
                </tr>
            `).join('');

            const html = `
                <div class="pedido-card" id="pedidoParaImprimir">
                    <div class="pedido-header">
                        <div class="pedido-id">
                            <span>#</span>${p.id}
                        </div>
                        <div class="pedido-status status-${p.status}">
                            ${p.status.toUpperCase()}
                        </div>
                    </div>
                    
                    <div class="pedido-data">
                        üìÖ ${dataFormatada}
                    </div>

                    <div class="secao">
                        <h2>üë§ Cliente</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Nome</div>
                                <div class="info-value">${p.cliente_nome}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Telefone</div>
                                <div class="info-value">${p.cliente_telefone}</div>
                            </div>
                        </div>
                    </div>

                    ${p.tipo_entrega === 'delivery' ? `
                        <div class="secao">
                            <h2>üìç Endere√ßo de Entrega</h2>
                            <div class="info-grid">
                                <div class="info-item" style="grid-column: span 2;">
                                    <div class="info-label">Endere√ßo Completo</div>
                                    <div class="info-value">${enderecoCompleto}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Bairro</div>
                                    <div class="info-value">${bairro}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Tipo</div>
                                    <div class="info-value">üöö Delivery</div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="secao">
                            <h2>üè† Retirada</h2>
                            <div class="info-item">
                                <div class="info-value">Cliente retirar√° no local</div>
                            </div>
                        </div>
                    `}

                    <div class="secao">
                        <h2>üìã Itens do Pedido</h2>
                        <table class="itens-tabela">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd</th>
                                    <th>Pre√ßo Unit.</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itensHtml}
                            </tbody>
                        </table>

                        <div class="total-pedido">
                            <span class="total-label">Subtotal:</span>
                            <span class="total-value">R$ ${parseFloat(p.subtotal).toFixed(2)}</span>
                        </div>
                        
                        ${p.tipo_entrega === 'delivery' && p.taxa_entrega > 0 ? `
                            <div class="total-pedido">
                                <span class="total-label">Taxa de entrega:</span>
                                <span class="total-value">R$ ${parseFloat(p.taxa_entrega).toFixed(2)}</span>
                            </div>
                        ` : ''}
                        
                        <div class="total-pedido">
                            <span class="total-label">TOTAL:</span>
                            <span class="total-value">R$ ${parseFloat(p.total).toFixed(2)}</span>
                        </div>
                    </div>

                    ${p.observacoes ? `
                        <div class="secao">
                            <h2>üìù Observa√ß√µes</h2>
                            <div class="info-item">
                                <div class="info-value">${p.observacoes}</div>
                            </div>
                        </div>
                    ` : ''}

                    <div class="acoes">
                        <button class="btn btn-primary" onclick="window.print()">
                            üñ®Ô∏è Imprimir Pedido
                        </button>
                        <button class="btn btn-success" onclick="abrirModalWhatsApp()">
                            üì± Enviar via WhatsApp
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('pedidoContainer').innerHTML = html;
        }

        function abrirModalWhatsApp() {
            document.getElementById('whatsappModal').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('whatsappModal').style.display = 'none';
        }

        function formatarMensagemWhatsApp() {
            const p = pedidoAtual;
            
            let mensagem = `üçΩÔ∏è *PEDIDO #${p.id}*\n`;
            mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            mensagem += `üë§ *Cliente:* ${p.cliente_nome}\n`;
            mensagem += `üì± *Contato:* ${p.cliente_telefone}\n`;
            mensagem += `üìÖ *Data:* ${formatarData(p.data_pedido)}\n\n`;
            
            mensagem += `üìã *ITENS DO PEDIDO:*\n`;
            mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            
            p.itens.forEach(item => {
                mensagem += `‚Ä¢ ${item.produto_nome}\n`;
                mensagem += `  ${item.quantidade}x R$ ${parseFloat(item.preco_unitario).toFixed(2)} = R$ ${parseFloat(item.subtotal).toFixed(2)}\n`;
            });
            
            mensagem += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            mensagem += `üí∞ *Subtotal:* R$ ${parseFloat(p.subtotal).toFixed(2)}\n`;
            
            if (p.tipo_entrega === 'delivery' && p.taxa_entrega > 0) {
                mensagem += `üöö *Taxa de entrega:* R$ ${parseFloat(p.taxa_entrega).toFixed(2)}\n`;
            }
            
            mensagem += `üíµ *TOTAL:* R$ ${parseFloat(p.total).toFixed(2)}\n\n`;
            
            if (p.tipo_entrega === 'delivery') {
                mensagem += `üìç *ENDERE√áO DE ENTREGA:*\n`;
                mensagem += `${p.cliente_endereco}\n`;
                if (p.cliente_bairro) mensagem += `Bairro: ${p.cliente_bairro}\n`;
            } else {
                mensagem += `üè† *RETIRADA NO LOCAL*\n`;
            }
            
            if (p.observacoes) {
                mensagem += `\nüìù *Observa√ß√µes:*\n${p.observacoes}\n`;
            }
            
            return encodeURIComponent(mensagem);
        }

        function enviarWhatsApp() {
            const numero = document.getElementById('whatsappNumero').value.replace(/\D/g, '');
            
            if (!numero || numero.length < 10) {
                alert('Digite um n√∫mero v√°lido com DDD');
                return;
            }
            
            const mensagem = formatarMensagemWhatsApp();
            const numeroFormatado = numero.includes('55') ? numero : `55${numero}`;
            
            window.open(`https://wa.me/${numeroFormatado}?text=${mensagem}`, '_blank');
            fecharModal();
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('whatsappModal');
            if (event.target === modal) {
                fecharModal();
            }
        };

        // Iniciar
        carregarPedido();
    </script>
</body>
</html>